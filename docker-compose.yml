version: "3.2"
services:
  # Internal services
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        HTTP_PROXY: http://proxy-dev.spk-berlin.de:3128
        HTTPS_PROXY: http://proxy-dev.spk-berlin.de:3128
        NO_PROXY: localhost,127.0.0.1
    environment:
      - HTTP_PROXY=http://proxy-dev.spk-berlin.de:3128
      - HTTPS_PROXY=http://proxy-dev.spk-berlin.de:3128
      - NO_PROXY=localhost,127.0.0.1

  gateway:
    build:
      context: services/gateway
      dockerfile: Dockerfile.dev
    volumes:
      - ./var/certs:/certs
    ports:
      - "${PORTS_GATEWAY_HTTPS:-8443}:443"
      - "${PORTS_GATEWAY:-8081}:8080"
    restart: unless-stopped
    depends_on:
      - tasks-api
      - model-api
      - madoc-ts
      - config-service
      - storage-api
      - okra
      - search

  madoc-ts:
    tty: true
    image: ghcr.io/digirati-co-uk/madoc-api:${MADOC_VERSION-main}
    build:
      context: services/madoc-ts
      dockerfile: Dockerfile.dev
      args:
        HTTP_PROXY: http://proxy-dev.spk-berlin.de:3128
        HTTPS_PROXY: http://proxy-dev.spk-berlin.de:3128
    volumes:
      #- ./services/madoc-ts/dist:/home/node/app/dist:delegated
      - ./services/madoc-ts/src:/home/node/app/src
      - ./services/madoc-ts/config.json:/home/node/app/config.json:delegated
      #- ./services/madoc-ts/package.json:/home/node/app/package.json:delegated
      #- ./services/madoc-ts/yarn.lock:/home/node/app/yarn.lock:delegated
      - ./services/madoc-ts/migrations:/home/node/app/migrations:delegated
      #- ./services/madoc-ts/schemas:/home/node/app/schemas:delegated
      #- ./services/madoc-ts/ecosystem.config.cjs:/home/node/app/ecosystem.config.cjs
      #- ./services/madoc-ts/vite:/home/node/app/vite:delegated
      #- ./services/madoc-ts/entrypoint:/home/node/app/entrypoint:delegated
      #- ./services/madoc-ts/config.json:/home/node/app/config.json
      #- ./services/madoc-ts/service-jwts:/home/node/app/service-jwts
      #- ./services/madoc-ts/themes:/home/node/app/themes
      #- ./services/madoc-ts/translations:/home/node/app/translations
      #- ./services/madoc-ts/npm:/home/node/app/npm
      - ./var/certs:/home/node/app/openssl-certs:cached
      - ./var/jwt:/home/node/app/service-jwt-responses
      - ./var/files:/home/node/app/files
    environment:
      - DATABASE_HOST=${POSTGRES_HOST}
      - DATABASE_NAME=${POSTGRES_DB}
      - DATABASE_PORT=${POSTGRES_PORT}
      - DATABASE_USER=${POSTGRES_MADOC_TS_USER}
      - DATABASE_SCHEMA=${POSTGRES_MADOC_TS_SCHEMA}
      - DATABASE_PASSWORD=${POSTGRES_MADOC_TS_PASSWORD}
      - REDIS_HOST=gateway-redis
      - API_GATEWAY=http://gateway:8080
      - GATEWAY_HOST=${GATEWAY_HOST}
      - STORAGE_FILE_DIRECTORY=/home/node/app/files
      - MADOC_INSTALLATION_CODE=${MADOC_INSTALLATION_CODE}
      - MIGRATE=true
      - NODE_ENV=production
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_SECURITY=${SMTP_SECURITY}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - MAIL_FROM_USER=${MAIL_FROM_USER}
      - HTTP_PROXY=http://proxy-dev.spk-berlin.de:3128
      - HTTPS_PROXY=http://proxy-dev.spk-berlin.de:3128
      - NO_PROXY=localhost,127.0.0.1,gateway-redis,${POSTGRES_HOST}
    ports:
      - "127.0.0.1:${PORTS_MADOC_TS_DEBUGGER:-9230}:9230"
      - "127.0.0.1:${PORTS_MADOC_TS_WEBPACK:-40493}:40493"
      - "3088:3088"
    user: "1000:1000"

  tasks-api:
    tty: true
    image: ghcr.io/digirati-co-uk/tasks-api:latest
    platform: linux/amd64
    environment:
      - SERVER_PORT=3000
      - DATABASE_HOST=${POSTGRES_HOST}
      - DATABASE_NAME=${POSTGRES_DB}
      - DATABASE_PORT=${POSTGRES_PORT}
      - DATABASE_USER=${POSTGRES_TASKS_API_USER}
      - DATABASE_SCHEMA=${POSTGRES_TASKS_API_SCHEMA}
      - DATABASE_PASSWORD=${POSTGRES_TASKS_API_PASSWORD}
      - QUEUE_LIST=${TASKS_QUEUE_LIST}
      - REDIS_HOST=gateway-redis
      - HTTP_PROXY=http://proxy-dev.spk-berlin.de:3128
      - HTTPS_PROXY=http://proxy-dev.spk-berlin.de:3128
      - NO_PROXY=localhost,127.0.0.1,gateway-redis,${POSTGRES_HOST}
    depends_on:
      - gateway-redis

  model-api:
    tty: true
    image: digirati/capture-models:latest
    platform: linux/amd64
    environment:
      - SERVER_PORT=3000
      - DATABASE_HOST=${POSTGRES_HOST}
      - DATABASE_NAME=${POSTGRES_DB}
      - DATABASE_PORT=${POSTGRES_PORT}
      - DATABASE_USER=${POSTGRES_MODELS_API_USER}
      - DATABASE_SCHEMA=${POSTGRES_MODELS_API_SCHEMA}
      - DATABASE_PASSWORD=${POSTGRES_MODELS_API_PASSWORD}
      - HTTP_PROXY=http://proxy-dev.spk-berlin.de:3128
      - HTTPS_PROXY=http://proxy-dev.spk-berlin.de:3128
      - NO_PROXY=localhost,127.0.0.1,${POSTGRES_HOST}

  # Comment out or remove shared-postgres since you're using external DB
  # shared-postgres:
  #   build:
  #     context: services/shared-postgres
  #   environment:
  #     - POSTGRES_HOST=${POSTGRES_HOST}
  #     # ... rest of config
  #   ports:
  #     - "${PORTS_SHARED_POSTGRES:-5400}:5432"
  #   volumes:
  #     - ./var/shared-database:/var/lib/postgresql/data

  gateway-redis:
    image: redis:5-alpine

  config-service:
    image: digirati/madoc_config_service_django:175410fc5b7dbef4cc259686564fbedeb60c8789
    platform: linux/amd64
    environment:
      - USE_DOCKER=yes
      - IPYTHONDIR=/app/.ipython
      - MIGRATE=True
      - LOAD=False
      - DJANGO_DEBUG=False
      - WAITRESS=False
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - POSTGRES_USER=${POSTGRES_CONFIG_SERVICE_USER}
      - POSTGRES_PASSWORD=${POSTGRES_CONFIG_SERVICE_PASSWORD}
      - POSTGRES_SCHEMA=${POSTGRES_CONFIG_SERVICE_SCHEMA}
      - POSTGRES_DB=${POSTGRES_DB}
      - DATABASE_URL=postgres://${POSTGRES_CONFIG_SERVICE_USER}:${POSTGRES_CONFIG_SERVICE_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}
      - HTTP_PROXY=http://proxy-dev.spk-berlin.de:3128
      - HTTPS_PROXY=http://proxy-dev.spk-berlin.de:3128
      - NO_PROXY=localhost,127.0.0.1,${POSTGRES_HOST}
    volumes:
      - ./configuration/schemas:/app/configurator/schemas
      - ./configuration/defaults:/app/configurator/default_config

  storage-api:
    tty: true
    image: ghcr.io/digirati-co-uk/storage-api:main
    platform: linux/amd64
    environment:
      - GATEWAY_HOST=${GATEWAY_HOST}
      - HTTP_PROXY=http://proxy-dev.spk-berlin.de:3128
      - HTTPS_PROXY=http://proxy-dev.spk-berlin.de:3128
      - NO_PROXY=localhost,127.0.0.1
    volumes:
      - ./var/files/storage-api:/home/node/app/files

  search:
    image: ghcr.io/digirati-co-uk/madoc-search-service:main 
    #image: ghcr.io/digirati-co-uk/madoc-search-service:247f854b1258e3971907e6912cef2374a1da8474
    platform: linux/amd64
    volumes:
      - /opt/madoc-search-service/search_service/search:/app/search
    environment:
      - BROWSABLE=False
      - USE_DOCKER=yes
      - IPYTHONDIR=/app/.ipython
      - MIGRATE=True
      - LOAD=False
      - DEBUG=True
      - DJANGO_DEBUG=True
      - WAITRESS=False
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - POSTGRES_USER=${POSTGRES_SEARCH_API_USER}
      - POSTGRES_PASSWORD=${POSTGRES_SEARCH_API_PASSWORD}
      - POSTGRES_SCHEMA=${POSTGRES_SEARCH_API_SCHEMA}
      - POSTGRES_DB=${POSTGRES_DB}
      - DATABASE_URL=postgres://${POSTGRES_SEARCH_API_USER}:${POSTGRES_SEARCH_API_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}
      - HTTP_PROXY=http://proxy-dev.spk-berlin.de:3128
      - HTTPS_PROXY=http://proxy-dev.spk-berlin.de:3128
      - NO_PROXY=localhost,127.0.0.1,${POSTGRES_HOST}
    
  okra:
    image: digirati/okra:latest
    platform: linux/amd64
    environment:
      - HTTP_PROXY=http://proxy-dev.spk-berlin.de:3128
      - HTTPS_PROXY=http://proxy-dev.spk-berlin.de:3128
      - NO_PROXY=localhost,127.0.0.1